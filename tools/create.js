"use strict";

add_translations({
	"es": {
		"Using this tool you can create your own custom eSeeCode platform to fit exactly your needs for each exercise.<br><br>Use the preview panel below to see and test live how eSeeCode will look like with your settings.<br>Once you are done setting it up, copy the URL and share it.": "",
		"Language": "Idioma",
		"Display translations menu?": "¿Mostrar menú de traducciones?",
		"Theme": "Tema",
		"Display themes menu?": "¿Mostrar menú de temas?",
		"Display file menu?": "¿Mostrar menú de archivos?",
		"Display fullscreen button?": "¿Mostrar botón de pantalla completa?",
		"Warn on exit if used has entered code?": "¿Advertir al salir si el usuario ha ingresado código?",
		"Initial view": "Vista inicial",
		"View tabs to display": "Pestañas de vista a mostrar",
		"Force block setup": "Forzar configuración de bloques",
		"Block setup style": "Estilo de configuración de bloques",
		"Display code console maximized?": "¿Mostrar consola de código maximizada?",
		"Milliseconds of delay between instructions": "Milisegundos de retraso entre instrucciones",
		"List of variables to observe": "Lista de variables a observar",
		"List of breakpoints and watchpoints": "Lista de puntos de interrupción y puntos de observación",
		"Whiteboard background": "Fondo de pizarra",
		"Display guide?": "¿Mostrar guía?",
		"Custom image for guide": "Imagen personalizada para la guía",
		"Size of the guide": "Tamaño de la guía",
		"Display grid?": "¿Mostrar cuadrícula?",
		"Amount of grid lines": "Cantidad de líneas de la cuadrícula",
		"Axis": "Eje",
		"Additional instructions' specifications": "Especificaciones de instrucciones adicionales",
		"Do you want to use a subset of instructions? If so, select which instructions to make available": "¿Deseas utilizar un subconjunto de instrucciones? En ese caso, selecciona qué instrucciones estarán disponibles",
		"Base path for media": "Ruta base para medios",
		"Code to preload (hidden to the user)": "Código para precargar (oculto para el usuario)",
		"Code to load as user code (displayed to the user)": "Código para cargar como código de usuario (visible para el usuario)",
		"Execute the user code": "Ejecutar el código del usuario",
		"Code to postload (hidden to the user)": "Código para postcargar (oculto para el usuario)",
		"Input": "Entrada",
		"Set the language you want for eSeeCode's user interface.": "Establece el idioma que deseas para la interfaz de usuario de eSeeCode.",
		"Decide whether the translations should be visible or hidden.": "Decide si las traducciones deben ser visibles u ocultas.",
		"Set the theme you want for eSeeCode's user interface.": "Establece el tema que deseas para la interfaz de usuario de eSeeCode.",
		"Decide whether the themes should be visible or hidden.": "Decide si los temas deben ser visibles u ocultos.",
		"Decide whether the buttons \"Load\" and \"Save\" should be visible or hidden.": "Decide si los botones \"Cargar\" y \"Guardar\" deben ser visibles u ocultos.",
		"Decide whether the fullscreen button should be visible or hidden.": "Decide si el botón de pantalla completa debe ser visible u oculto.",
		"Decide whether or not eSeeCode should require confirmation before being closed (or before changing the webpage).": "Decide si eSeeCode debe requerir confirmación antes de cerrarse (o antes de cambiar la página web).",
		"Select the view which will be displayed initially.": "Selecciona la vista que se mostrará inicialmente.",
		"Select which views will be available.": "Selecciona qué vistas estarán disponibles.",
		"Force block setup when adding instructions in Drag mode.": "Forzar la configuración de bloques al agregar instrucciones en el modo de arrastre.",
		"Select how to view the setup of blocks. In Drag view blocks are always setup in visually by default, but in Build view you can decide whether to display the text setup by default or the visual interface by default.": "Selecciona cómo ver la configuración de bloques. En la vista de arrastre, los bloques siempre se configuran visualmente de forma predeterminada, pero en la vista de construcción, puedes decidir si mostrar la configuración de texto de forma predeterminada o la interfaz visual de forma predeterminada.",
		"Decide whether the code console should be maximized initially.": "Decide si la consola de código debe estar maximizada inicialmente.",
		"Pause execution every time an instruction is run, to help debugging.": "Pausar la ejecución cada vez que se ejecuta una instrucción, para ayudar en la depuración.",
		"Comma-separated list variables to observe.<br>Example: index,question,answer": "Lista de variables separadas por comas para observar.<br>Ejemplo: índice, pregunta, respuesta",
		"Comma-separated list of breakpoints (line number) and/or watchpoints (break when variable's value changes).<br>Example: index,4,10,question,answer,25": "Lista de puntos de interrupción (número de línea) y/o puntos de observación (interrumpir cuando cambia el valor de la variable), separados por comas.<br>Ejemplo: índice,4,10, pregunta, respuesta, 25",
		"Display an image as background in all whiteboard layers. The image can be a public URL or an image name (which must be uploaded)": "Mostrar una imagen como fondo en todas las capas de la pizarra. La imagen puede ser una URL pública o un nombre de imagen (que debe cargarse)",
		"Decide whether the guide (the cursor in the whiteboard) will be visible or hidden.": "Decide si la guía (el cursor en la pizarra) estará visible u oculta.",
		"Display a custom image instead of the default guide. The image can be a public URL or an image name (which must be uploaded)": "Mostrar una imagen personalizada en lugar de la guía predeterminada. La imagen puede ser una URL pública o un nombre de imagen (que debe cargarse)",
		"Size of the guide in pixels (size is used for both width and height)": "Tamaño de la guía en píxeles (el tamaño se utiliza tanto para el ancho como para la altura).",
		"Decide whether the grid (the lines in the whiteboard) will be visible or hidden.": "Decide si la cuadrícula (las líneas en la pizarra) estarán visibles u ocultas.",
		"Set the amount of lines in the grid.": "Establece la cantidad de líneas en la cuadrícula.",
		"Select which coordinates you want:<br /><ul><li>Computer console: Origin is at upper left corner, increments right and downwards</li><li>Mathematical simple: Origin is at lower left corner, increments right and upwards</li><li>Mathematical centered: Origin is centered, increments right and upwards</li></ul>": "Selecciona las coordenadas que deseas:<br /><ul><li>Consola de computadora: El origen está en la esquina superior izquierda, aumenta hacia la derecha y hacia abajo</li><li>Matemática simple: El origen está en la esquina inferior izquierda, aumenta hacia la derecha y hacia arriba</li><li>Matemática centrada: El origen está centrado, aumenta hacia la derecha y hacia arriba</li></ul>",
		"Additional instructions to add to the programming environment, available to the users. The icon can be a public URL or an image name (which must be uploaded)": "Instrucciones adicionales para agregar al entorno de programación, disponibles para los usuarios. El icono puede ser una URL pública o un nombre de imagen (que debe cargarse)",
		"Here you can choose a subset of intructions to be available to the user (all others will be disabled).<ul style=\"text-align:justify;\"></li><li>Add them by selecting an instruction in the first column and clicking the \"Add\" button. You can add an instruction several times.</li><li>Double-click any instruction in the buttom column to set up its parameters, the amount of times the instruction can be used and whether or not the user can set up its parameters. Remember to click \"Apply\" to apply after you finish setting up every instruction.</li><li>Move up and down any instruction in the bottom column by selecting it and clicking the \"Up\" or \"Down\" buttons.</li><li>You can remove an instruction from the right column by selecting it and clicking the \"Remove\"button.</li><li>Click the \"Add spacer\" button to add a separator to the instructions in the bottom column. The separator will be added at the end, remember to move it up with the \"Up\" button.</li></ul>": "Aquí puedes elegir un subconjunto de instrucciones disponibles para el usuario (todas las demás estarán deshabilitadas).<ul style=\"text-align:justify;\"></li><li>Añádelas seleccionando una instrucción en la primera columna y haciendo clic en el botón \"Añadir\". Puedes agregar una instrucción varias veces.</li><li>Haz doble clic en cualquier instrucción en la columna inferior para configurar sus parámetros, la cantidad de veces que se puede usar la instrucción y si el usuario puede configurar sus parámetros. Recuerda hacer clic en \"Aplicar\" para aplicar después de configurar cada instrucción.</li><li>Mueve hacia arriba y hacia abajo cualquier instrucción en la columna inferior seleccionándola y haciendo clic en los botones \"Arriba\" o \"Abajo\".</li><li>Puedes quitar una instrucción de la columna derecha seleccionándola y haciendo clic en el botón \"Quitar\".</li><li>Haz clic en el botón \"Añadir separador\" para agregar un separador a las instrucciones en la columna inferior. El separador se agregará al final, recuerda moverlo hacia arriba con el botón \"Arriba\".</li></ul>",
		"Base path to prefix to relative paths for the sources of image() and sound() instructions": "Ruta base para prefijar rutas relativas para las fuentes de las instrucciones image() y sound()",
		"The code you write here will be hidden to the user but will be run immediately after loading eSeeCode and everytime before the user code.": "El código que escribas aquí estará oculto para el usuario, pero se ejecutará inmediatamente después de cargar eSeeCode y cada vez antes del código del usuario.",
		"The code you write here will be shown as part of the solution, so the user can view it and modify it.": "El código que escribas aquí se mostrará como parte de la solución, para que el usuario pueda verlo y modificarlo.",
		"Decide whether or not to run the user code immediately after loading eSeeCode.": "Decide si ejecutar o no el código del usuario inmediatamente después de cargar eSeeCode.",
		"The code you write here will be hidden to the user but will be run everytime after the user code.": "El código que escribas aquí estará oculto para el usuario, pero se ejecutará cada vez después del código del usuario.",
		"Set the input that will appear in the I/O toolbox.": "Establece la entrada que aparecerá en el diálogo de E/S.",
		"Yes": "Sí",
		"No": "No",
		"Computer console": "Consola de la computadora",
		"Mathematical simple": "Matemática simple",
		"Mathematical centered": "Matemática centrada",
		"Touch": "Toca",
		"Drag": "Mueve",
		"Build": "Monta",
		"Code": "Código",
		"Visual": "Visual",
		"Text": "Texto",
		"Application settings": "Configuración de la aplicación",
		"Default": "Por defecto",
		"Your saved value": "Tu valor guardado",
		"Programming environment": "Entorno de programación",
		"Whiteboard": "Pizarra",
		"Instructions": "Instrucciones",
		"Share": "Compartir",
		"Resolution": "Resolución",
		"Resolution in the whiteboard, the number applies to both width and height": "Resolución de la pizarra, el número se aplica a la resolución horizontal y a la vertical",
		"Autosave periodicity (in seconds)": "Periodicidad del autoguardado (en segundos)",
		"The user code will be internally autosaved with this frequency. Set to 0 to disable.": "El código de usuario se autoguardará internamente con esta frecuencia. 0 para deshabilitar.",
		"Blocks display style": "Estilo de visualización de los bloques",
		"Style in which the blocks are displayed.": "Estilo con el que se visualizarán los bloques.",
		"Display blocks style toggle": "Mostrar el selector de estilo de bloques",
		"Allow to switch style.": "Permitir cambiar el estilo de visualización de los bloques.",
		"Allow blocks multiselect": "Permitir seleccionar múltiples bloques",
		"Allow to select multiple blocks to perform actions.": "Permitir seleccionar múltiples bloques para realizar acciones.",
		"Set the amount of milliseconds gap between two instructions. Some of this time will be use to animate whiteboard movements and some to distinct the end of a movement with the beginning of the next (see the next configuration item).": "Establece la cantidad de milisegundos entre la ejecución de dos instrucciones. Parte de este tiempo se usará para animar el movimiento en la pizarra y parte para distinguir el final del movimiento de una instrucción del inicio del movimiento de la siguiente instrucción (ver el siguiente elemento de configuración).",
		"Milliseconds of pause between instructions": "Milisegundos de pausa entre dos instrucciones",
		"Set the amount of milliseconds to pause execution between two instructions. This time must be contained within the time defined in the previous configuration item. Combining the two one can achieve no movement animation, no pause, or any combination in between.": "Establece la cantidad de milisegundos que se pausa la ejecución entre dos instrucciones. Este tiempo debe estar contenido dentro del tiempo definido en el anterior elemento de configuración. Combinando los dos se puede conseguir que no haya animación de los movimientos, que no haya pausa entre instrucciones, o cualquier combinación entre las dos.",
		"Amount of instructions run on every stepped execution": "Número de instrucciones a ejecutar en cada ejecución paso a paso",
		"Define the amount of instructions that will be run every time the user requests to execute one step forward/backwards from the debug panel.": "Define el número de instrucciones que se ejecutan hacia adelante o hacia atrás cada vez que se solicita la ejecución de un paso en el panel de depuración.",
		"Restore autosaved code at initialization": "Al iniciar restaurar el último código autoguardado.",
		"Load the last autosaved code at initialization.": "Al iniciar restaurar el último código autoguardado.",
		"Autosaved code expration (in seconds)": "Caducidad del código autoguardado (en segundos)",
		"Time after which autosaved code cannot be restored. Set to 0 to never expire.": "Tiempo a partir del cual el código autoguardado no se puede restaurar. Poner 0 para no caducar nunca",
		"Exercise id": "Identificador del ejercicio",
		"Identify this exercise (if set, autosaved code in this exercise will only be restored for this exercise)": "Identifica el ejercicio (de esta manera el código autoguardado para este ejercicio solo se restaurará en este ejercicio)",
		"User interface": "Interfaz de usuario",
		"Autosave": "Autoguardado",
		"Development environment": "Entorno de desarrollo",
		"Execution animation": "Animación de la ejecución",
		"Debugging": "Depuración",
		"Scene": "Escena",
		"Grid properties": "Propiedades de la cuadrícula",
		"Load defaults": "Carga valores por defecto",
		"Filter": "Filtro",
		"Full view": "Vista completa",
		"Wizard view": "Vista asistida",
		"Up": "Arriba",
		"Down": "Abajo",
		"Customize": "Personalizar",
		"Add spacer": "Añadir espaciador",
		"Remove": "Borrar",
		"Add": "Añadir",
		"Add instruction": "Añadir instrucción",
		"Name": "Nombre",
		"Type": "Tipo",
		"Description": "Descripción",
		"Is optional": "Es opcional",
		"Default value": "Valor por defecto",
		"Remove parameter": "Eliminar parámetro",
		"Apply": "Aplicar",
		"Implement the instruction": "Implementación de la instrucción",
		"URL or image name": "URL o nombre de imagen",
		"Icon": "Icono",
		"Show in": "Mostrar en",
		"Category": "Categoría",
		"Name": "Nombre",
		"Count as a single instruction": "Contar como una única instrucción",
		"Keep animation": "Mantener animación",
	},
	"ca": {
		"Using this tool you can create your own custom eSeeCode platform to fit exactly your needs for each exercise.<br><br>Use the preview panel below to see and test live how eSeeCode will look like with your settings.<br>Once you are done setting it up, copy the URL and share it.": "",
		"Language": "Idioma",
		"Display translations menu?": "Mostrar menú de traducciones?",
		"Theme": "Tema",
		"Display themes menu?": "Mostrar menú de temes?",
		"Display file menu?": "Mostrar menú de fitxers?",
		"Display fullscreen button?": "Mostrar botó de pantalla completa?",
		"Warn on exit if used has entered code?": "Alerta en sortir si l'usuari ha introduït codi?",
		"Initial view": "Vista inicial",
		"View tabs to display": "Pestanyes de vista a mostrar",
		"Force block setup": "Forçar configuració de blocs",
		"Block setup style": "Estil de configuració de blocs",
		"Display code console maximized?": "Mostrar consola de codi a la màxima grandària?",
		"Milliseconds of delay between instructions": "Milisegons de retard entre les instruccions",
		"List of variables to observe": "Llista de variables a observar",
		"List of breakpoints and watchpoints": "Llista de punts d'aturada i punts de vigilància",
		"Whiteboard background": "Fons de pissarra",
		"Display guide?": "Mostrar guia?",
		"Custom image for guide": "Imatge personalitzada per a la guia",
		"Size of the guide": "Mida de la guia",
		"Display grid?": "Mostrar graella?",
		"Amount of grid lines": "Quantitat de línies de la graella",
		"Axis": "Eix",
		"Additional instructions' specifications": "Especificacions d'instruccions addicionals",
		"Do you want to use a subset of instructions? If so, select which instructions to make available": "Vols fer servir un subconjunt d'instruccions? En aquest cas, selecciona quines instruccions vols fer disponibles",
		"Base path for media": "Ruta base per a mitjans",
		"Code to preload (hidden to the user)": "Codi a precarregar (ocult a l'usuari)",
		"Code to load as user code (displayed to the user)": "Codi a carregar com a codi d'usuari (visible a l'usuari)",
		"Execute the user code": "Executar el codi de l'usuari",
		"Code to postload (hidden to the user)": "Codi a postcarregar (ocult a l'usuari)",
		"Input": "Entrada",
		"Set the language you want for eSeeCode's user interface.": "Estableix l'idioma que vols per a la interfície d'usuari de l'eSeeCode.",
		"Decide whether the translations should be visible or hidden.": "Decideix si les traduccions han de ser visibles o ocultes.",
		"Set the theme you want for eSeeCode's user interface.": "Estableix el tema que vols per a la interfície d'usuari de l'eSeeCode.",
		"Decide whether the themes should be visible or hidden.": "Decideix si els temes han de ser visibles o ocults.",
		"Decide whether the buttons \"Load\" and \"Save\" should be visible or hidden.": "Decideix si els botons \"Carregar\" i \"Desar\" han de ser visibles o ocults.",
		"Decide whether the fullscreen button should be visible or hidden.": "Decideix si el botó de pantalla completa ha de ser visible o ocult.",
		"Decide whether or not eSeeCode should require confirmation before being closed (or before changing the webpage).": "Decideix si l'eSeeCode ha de requerir confirmació abans de tancar-se (o abans de canviar la pàgina web).",
		"Select the view which will be displayed initially.": "Selecciona la vista que es mostrarà inicialment.",
		"Select which views will be available.": "Selecciona quines vistes estaran disponibles.",
		"Force block setup when adding instructions in Drag mode.": "Força la configuració de blocs en afegir instruccions en el mode d'arrossegament.",
		"Select how to view the setup of blocks. In Drag view blocks are always setup in visually by default, but in Build view you can decide whether to display the text setup by default or the visual interface by default.": "Selecciona com veure la configuració de blocs. A la vista d'arrossegament, els blocs sempre es configuren visualment de forma predeterminada, però a la vista de construcció, pots decidir si mostrar la configuració de text de forma predeterminada o la interfície visual de forma predeterminada.",
		"Decide whether the code console should be maximized initially.": "Decideix si la consola de codi ha d'estar a la màxima grandària inicialment.",
		"Pause execution every time an instruction is run, to help debugging.": "Pausa l'execució cada vegada que s'executa una instrucció, per ajudar a la depuració.",
		"Comma-separated list variables to observe.<br>Example: index,question,answer": "Llista de variables separades per comes per observar.<br>Exemple: índex, pregunta, resposta",
		"Comma-separated list of breakpoints (line number) and/or watchpoints (break when variable's value changes).<br>Example: index,4,10,question,answer,25": "Llista de punts d'aturada (número de línia) i/o punts de vigilància (aturada quan canvia el valor de la variable), separats per comes.<br>Exemple: índex,4,10, pregunta, resposta, 25",
		"Display an image as background in all whiteboard layers. The image can be a public URL or an image name (which must be uploaded)": "Mostra una imatge com a fons en totes les capes de la pissarra. La imatge pot ser una URL pública o un nom d'imatge (que s'ha de pujar)",
		"Decide whether the guide (the cursor in the whiteboard) will be visible or hidden.": "Decideix si la guia (el cursor a la pissarra) serà visible o oculta.",
		"Display a custom image instead of the default guide. The image can be a public URL or an image name (which must be uploaded)": "Mostra una imatge personalitzada en lloc de la guia predeterminada. La imatge pot ser una URL pública o un nom d'imatge (que s'ha de pujar)",
		"Size of the guide in pixels (size is used for both width and height)": "Mida de la guia en píxels (la mida s'utilitza tant per l'amplada com per l'altura).",
		"Decide whether the grid (the lines in the whiteboard) will be visible or hidden.": "Decideix si la graella (les línies a la pissarra) serà visible o oculta.",
		"Set the amount of lines in the grid.": "Estableix la quantitat de línies a la graella.",
		"Select which coordinates you want:<br /><ul><li>Computer console: Origin is at upper left corner, increments right and downwards</li><li>Mathematical simple: Origin is at lower left corner, increments right and upwards</li><li>Mathematical centered: Origin is centered, increments right and upwards</li></ul>": "Selecciona les coordenades que vols:<br /><ul><li>Consola de computadora: L'origen està a la cantonada superior esquerra, augmenta cap a la dreta i cap avall</li><li>Matemàtica simple: L'origen està a la cantonada inferior esquerra, augmenta cap a la dreta i cap amunt</li><li>Matemàtica centrada: L'origen està centrat, augmenta cap a la dreta i cap amunt</li></ul>",
		"Additional instructions to add to the programming environment, available to the users. The icon can be a public URL or an image name (which must be uploaded)": "Instruccions addicionals per afegir a l'entorn de programació, disponibles per als usuaris. La icona pot ser una URL pública o un nom d'imatge (que s'ha de pujar)",
		"Here you can choose a subset of instructions to be available to the user (all others will be disabled).<ul style=\"text-align:justify;\"></li><li>Add them by selecting an instruction in the first column and clicking the \"Add\" button. You can add an instruction several times.</li><li>Double-click any instruction in the buttom column to set up its parameters, the amount of times the instruction can be used and whether or not the user can set up its parameters. Remember to click \"Apply\" to apply after you finish setting up every instruction.</li><li>Move up and down any instruction in the bottom column by selecting it and clicking the \"Up\" or \"Down\" buttons.</li><li>You can remove an instruction from the right column by selecting it and clicking the \"Remove\"button.</li><li>Click the \"Add spacer\" button to add a separator to the instructions in the bottom column. The separator will be added at the end, remember to move it up with the \"Up\" button.</li></ul>": "Aquí pots triar un subconjunt d'instruccions disponibles per a l'usuari (totes les altres estaran inhabilitades).<ul style=\"text-align:justify;\"></li><li>Afegix-les seleccionant una instrucció a la primera columna i fent clic al botó \"Afegeix\". Pots afegir una instrucció diverses vegades.</li><li>Fes doble clic a qualsevol instrucció a la columna inferior per configurar els seus paràmetres, la quantitat de vegades que es pot utilitzar la instrucció i si l'usuari pot configurar els seus paràmetres. Recorda fer clic a \"Aplica\" per aplicar-ho després de configurar cada instrucció.</li><li>Mou amunt i avall qualsevol instrucció a la columna inferior seleccionant-la i fent clic als botons \"Amunt\" o \"Avall\".</li><li>Pots eliminar una instrucció de la columna de la dreta seleccionant-la i fent clic al botó \"Elimina\".</li><li>Fes clic al botó \"Afegeix separador\" per afegir un separador a les instruccions a la columna inferior. El separador s'afegirà al final, recorda moure'l amunt amb el botó \"Amunt\".</li></ul>",
		"Base path to prefix to relative paths for the sources of image() and sound() instructions": "Ruta base per afegir com a prefix a les rutes relatives per a les fonts de les instruccions image() i sound()",
		"The code you write here will be hidden to the user but will be run immediately after loading eSeeCode and everytime before the user code.": "El codi que escriguis aquí serà ocult a l'usuari, però s'executarà immediatament després de carregar l'eSeeCode i sempre abans del codi de l'usuari.",
		"The code you write here will be shown as part of the solution, so the user can view it and modify it.": "El codi que escriguis aquí es mostrarà com a part de la solució, de manera que l'usuari pugui veure'l i modificar-lo.",
		"Decide whether or not to run the user code immediately after loading eSeeCode.": "Decideix si executar o no el codi de l'usuari immediatament després de carregar l'eSeeCode.",
		"The code you write here will be hidden to the user but will be run everytime after the user code.": "El codi que escriguis aquí serà ocult a l'usuari, però s'executarà sempre després del codi de l'usuari.",
		"Set the input that will appear in the I/O toolbox.": "Estableix l'entrada que apareixerà al diàleg d'E/S.",
		"Yes": "Sí",
		"No": "No",
		"Computer console": "Consola de la computadora",
		"Mathematical simple": "Matemàtica simple",
		"Mathematical centered": "Matemàtica centrada",
		"Touch": "Toca",
		"Drag": "Mou",
		"Build": "Munta",
		"Code": "Codi",
		"Visual": "Visual",
		"Text": "Text",
		"Application settings": "Configuració de l'aplicació",
		"Default": "Per defecte",
		"Your saved value": "El teu valor desat",
		"Programming environment": "Entorn de programació",
		"Whiteboard": "Pissarra",
		"Instructions": "Instruccions",
		"Share": "Compartir",
		"Resolution": "Resolució",
		"Resolution in the whiteboard, the number applies to both width and height": "Resolució a la pissarra, el número aplica a la resolució horitzontal i a la vertical",
		"Autosave periodicity (in seconds)": "Periodicitat de l'autoguardat (en segons)",
		"The user code will be internally autosaved with this frequency. Set to 0 to disable.": "El codi d'usuari es guardarà automàticament amb aquesta freqüència internament. Estableix 0 per desactivar-ho.",
		"Blocks display style": "Estil de visualització dels blocs",
		"Style in which the blocks are displayed.": "Estil amb què es visualitzaran els blocs.",
		"Display blocks style toggle": "Mostrar el selector d'estil de blocs",
		"Allow to switch style.": "Permetre canviar l'estil de visualització dels blocs.",
		"Allow blocks multiselect": "Permetre seleccionar múltiples blocs",
		"Allow to select multiple blocks to perform actions.": "Permetre seleccionar múltiples blocs per realitzar accions.",
		"Set the amount of milliseconds gap between two instructions. Some of this time will be use to animate whiteboard movements and some to distinct the end of a movement with the beginning of the next (see the next configuration item).": "Estableix la quantitat de mil·lisegons entre l'execució de dues instruccions. Part d'aquest temps s'utilitzarà per animar el moviment a la pissarra i part per distingir el final d'un moviment amb l'inici del següent (veure l'element de configuració següent).",
		"Milliseconds of pause between instructions": "Mil·lisegons de pausa entre dues instruccions",
		"Set the amount of milliseconds to pause execution between two instructions. This time must be contained within the time defined in the previous configuration item. Combining the two one can achieve no movement animation, no pause, or any combination in between.": "Estableix la quantitat de mil·lisegons que es pausa l'execució entre dues instruccions. Aquest temps ha d'estar contingut dins del temps definit en l'element de configuració anterior. Combinant els dos es pot aconseguir que no hi hagi animació dels moviments, que no hi hagi pausa entre instruccions, o qualsevol combinació entre els dos.",
		"Amount of instructions run on every stepped execution": "Nombre d'instruccions a executar en cada execució pas a pas",
		"Define the amount of instructions that will be run every time the user requests to execute one step forward/backwards from the debug panel.": "Defineix el nombre d'instruccions que s'executen cap endavant o cap enrere cada vegada que l'usuari sol·licita l'execució d'un pas al panell de depuració.",
		"Display button to restore autosaved code": "Mostrar botó per restaurar l'últim codi autoguardat",
		"Restore autosaved code at initialization": "En iniciar restaurar el darrer codi autodesat.",
		"Load the last autosaved code at initialization.": "En iniciar, carregar l'últim codi autoguardat.",
		"Autosaved code expration (in seconds)": "Caducitat del codi autoguardat (en segons)",
		"Time after which autosaved code cannot be restored. Set to 0 to never expire.": "Temps a partir del qual el codi autoguardat no es pot restaurar. Posar 0 per no caducar mai.",
		"Exercise id": "Identificador de l'exercici",
		"Identify this exercise (if set, autosaved code in this exercise will only be restored for this exercise)": "Identifica l'exercici (d'aquesta manera el codi autoguardat per aquest exercici només es restaurarà en aquest exercici)",
		"User interface": "Interfície d'usuari",
		"Autosave": "Autodesat",
		"Development environment": "Entorn de desenvolupament",
		"Execution animation": "Animació de l'execució",
		"Debugging": "Depuració",
		"Scene": "Escena",
		"Grid properties": "Propietats de la quadrícula",
		"Load defaults": "Carrega valors per defecte",
		"Filter": "Filtre",
		"Full view": "Vista completa",
		"Wizard view": "Vista assistida",
		"Up": "Amunt",
		"Down": "Avall",
		"Customize": "Personalitzar",
		"Add spacer": "Afegir espaciador",
		"Remove": "Esborrar",
		"Add": "Afegir",
		"Add instruction": "Afegir instrucció",
		"Name": "Nom",
		"Type": "Tipus",
		"Description": "Descripció",
		"Is optional": "És opcional",
		"Default value": "Valor per defecte",
		"Remove parameter": "Eliminar paràmetre",
		"Apply": "Aplicar",
		"Implement the instruction": "Implementació de la instrucció",
		"URL or image name": "URL o nom de imatge",
		"Icon": "Icone",
		"Show in": "Mostrar a",
		"Category": "Categoria",
		"Name": "Nom",
		"Count as a single instruction": "Comptar com una única instrucció",
		"Keep animation": "Mantindre animació",
	}
});

if (!$e) var $e = {};
if (!$e.instructions) $e.instructions = {};
if (!$e.ide) $e.ide = {};
if (!$e.ui) $e.ui = {};
if (!$e.ui.translations) $e.ui.translations = {};
if (!$e.ui.themes) $e.ui.themes = {};
var handle;
$e.instructions._set = $e.instructions.set;
$e.instructions.set = Object.assign({}, $e.instructions._set);
var mainURL;
var setupItems = {
	"Introduction": {
		introduction: { type: "html", html: _("Using this tool you can create your own custom eSeeCode platform to fit exactly your needs for each exercise.<br><br>Use the preview panel below to see and test live how eSeeCode will look like with your settings.<br>Once you are done setting it up, copy the URL and share it."), skipParameterInURL: true, },
	},
	"Application settings": {
		interface: { title: "User interface", type: "fieldset" },
		lang: { title: "Language", type: "select", options: $e.ui.translations.available, sort: true, initial: "default", help: "Set the language you want for eSeeCode's user interface.", fieldset: "interface", },
		translations: { title: "Display translations menu?", type: "select", options: ["Yes", "No"], initial: "Yes", help: "Decide whether the translations should be visible or hidden.", fieldset: "interface", advanced: true, },
		theme: { title: "Theme", type: "select", options: $e.ui.themes.available, initial: "default", sort: true, help: "Set the theme you want for eSeeCode's user interface.", fieldset: "interface", },
		themes: { title: "Display themes menu?", type: "select", options: ["Yes", "No"], initial: "Yes", help: "Decide whether the themes should be visible or hidden.", fieldset: "interface", advanced: true, },
		filemenu: { title: "Display file menu?", type: "select", options: ["Yes", "No"], initial: "Yes", help: "Decide whether the buttons \"Load\" and \"Save\" should be visible or hidden.", fieldset: "interface", advanced: true, },
		fullscreenmenu: { title: "Display fullscreen button?", type: "select", options: ["Yes", "No"], initial: "Yes", help: "Decide whether the fullscreen button should be visible or hidden.", fieldset: "interface", advanced: true, },
		preventexit: { title: "Warn on exit if used has entered code?", type: "select", options: ["Yes", "No"], initial: "Yes", help: "Decide whether or not eSeeCode should require confirmation before being closed (or before changing the webpage).", fieldset: "interface", },
		save_session: { title: "Autosave", type: "fieldset" },
		autosave: { title: "Autosave periodicity (in seconds)", type: "number", initial: "60", min: "0", help: "The user code will be internally autosaved with this frequency. Set to 0 to disable.", fieldset: "save_session", advanced: true, },
		autosaveexpire: { title: "Autosaved code expration (in seconds)", type: "number", initial: "0", help: "Time after which autosaved code cannot be restored. Set to 0 to never expire.", fieldset: "save_session", advanced: true, },
		autorestore: { title: "Restore autosaved code at initialization", type: "checkbox", initial: "false", help: "Load the last autosaved code at initialization.", fieldset: "save_session", },
		exercise: { title: "Exercise id", type: "text", help: "Identify this exercise (if set, autosaved code in this exercise will only be restored for this exercise)", fieldset: "save_session", advanced: true, },
	},
	"Programming environment": {
		ide: { title: "Development environment", type: "fieldset" },
		view: { title: "Initial view", type: "select", options: ["Touch", "Drag", "Build", "Code"], initial: "Touch", help: "Select the view which will be displayed initially.", fieldset: "ide", },
		viewtabs: { title: "View tabs to display", type: "multiple", options: ["Touch", "Drag", "Build", "Code"], initial: "Touch;Drag;Build;Code", help: "Select which views will be available.", fieldset: "ide", advanced: true, },
		style: { title: "Blocks display style", type: "select", options: ["Code", "Flow"], initial: "Code", help: "Style in which the blocks are displayed.", fieldset: "ide", },
		styletabs: { title: "Display blocks style toggle", type: "checkbox", initial: "true", help: "Allow to switch style.", fieldset: "ide", advanced: true, },
		multiselect: { title: "Allow blocks multiselect", type: "checkbox", initial: "true", help: "Allow to select multiple blocks to perform actions.", fieldset: "ide", advanced: true, },
		forceblocksetup: { title: "Force block setup", type: "checkbox", initial: "true", help: "Force block setup when adding instructions in Drag mode.", fieldset: "ide", advanced: true, },
		blocksetup: { title: "Block setup style", type: "select", options: ["Visual", "Text"], initial: "Text", help: "Select how to view the setup of blocks. In Drag view blocks are always setup in visually by default, but in Build view you can decide whether to display the text setup by default or the visual interface by default.", fieldset: "ide", advanced: true, },
		maximize: { title: "Display code console maximized?", type: "select", options: ["Yes", "No"], initial: "No", help: "Decide whether the code console should be maximized initially.", fieldset: "ide", },
		execution_animation: { title: "Execution animation", type: "fieldset" },
		delay: { title: "Milliseconds of delay between instructions", type: "number", initial: "200", min: "0", help: "Set the amount of milliseconds gap between two instructions. Some of this time will be use to animate whiteboard movements and some to distinct the end of a movement with the beginning of the next (see the next configuration item).", fieldset: "execution_animation", advanced: true, },
		pause: { title: "Milliseconds of pause between instructions", type: "number", initial: "100", min: "0", help: "Set the amount of milliseconds to pause execution between two instructions. This time must be contained within the time defined in the previous configuration item. Combining the two one can achieve no movement animation, no pause, or any combination in between.", fieldset: "execution_animation", advanced: true, },
		debugging: { title: "Debugging", type: "fieldset" },
		observe: { title: "List of variables to observe", type: "text", initial: "", help: "Comma-separated list variables to observe.<br>Example: index,question,answer", fieldset: "debugging", advanced: true, },
		breakpoints: { title: "List of breakpoints and watchpoints", type: "text", initial: "", help: "Comma-separated list of breakpoints (line number) and/or watchpoints (break when variable's value changes).<br>Example: index,4,10,question,answer,25", fieldset: "debugging", advanced: true, },
		stepsize: { title: "Amount of instructions run on every stepped execution", type: "number", initial: "1", help: "Define the amount of instructions that will be run every time the user requests to execute one step forward/backwards from the debug panel.", fieldset: "debugging", advanced: true, },
	},
	"Whiteboard": {
		scene: { title: "Scene", type: "fieldset" },
		background: { title: "Whiteboard background", type: "text", help: "Display an image as background in all whiteboard layers. The image can be a public URL or an image name (which must be uploaded)", fieldset: "scene", },
		guide: { title: "Display guide?", type: "select", options: ["Yes", "No"], initial: "Yes", help: "Decide whether the guide (the cursor in the whiteboard) will be visible or hidden.", fieldset: "scene", advanced: true, },
		guideimage: { title: "Custom image for guide", type: "text", help: "Display a custom image instead of the default guide. The image can be a public URL or an image name (which must be uploaded)", fieldset: "scene", },
		guidesize: { title: "Size of the guide", type: "number", initial: "20", min: "0", help: "Size of the guide in pixels (size is used for both width and height)", fieldset: "scene", },
		grid_properties: { title: "Grid properties", type: "fieldset" },
		grid: { title: "Display grid?", type: "select", options: ["Yes", "No"], initial: "Yes", help: "Decide whether the grid (the lines in the whiteboard) will be visible or hidden.", fieldset: "grid_properties", },
		griddivisions: { title: "Amount of grid lines", type: "number", initial: "15", min: "0", help: "Set the amount of lines in the grid.", fieldset: "grid_properties", },
		axis: { title: "Axis", type: "select", options: ["Computer console", "Mathematical simple", "Mathematical centered"], initial: "Mathematical centered", help: "Select which coordinates you want:<br /><ul><li>Computer console: Origin is at upper left corner, increments right and downwards</li><li>Mathematical simple: Origin is at lower left corner, increments right and upwards</li><li>Mathematical centered: Origin is centered, increments right and upwards</li></ul>", fieldset: "grid_properties", fieldset: "grid_properties", },
		whiteboardresolution: { title: "Resolution", type: "number", initial: 600, min: "0", help: "Resolution in the whiteboard, the number applies to both width and height", fieldset: "grid_properties", advanced: true, },
	},
	"Instructions": {
		custominstructions: { title: "Additional instructions' specifications", type: "custominstructions", initial: "{}", help: "Additional instructions to add to the programming environment, available to the users. The icon can be a public URL or an image name (which must be uploaded)", advanced: true, },
		instructions: { title: "Do you want to use a subset of instructions? If so, select which instructions to make available", type: "instructions", options: function() { return $e.instructions.set; }, initial: "", help: "Here you can choose a subset of intructions to be available to the user (all others will be disabled).<ul style=\"text-align:justify;\"></li><li>Add them by selecting an instruction in the first column and clicking the \"Add\" button. You can add an instruction several times.</li><li>Double-click any instruction in the buttom column to set up its parameters, the amount of times the instruction can be used and whether or not the user can set up its parameters. Remember to click \"Apply\" to apply after you finish setting up every instruction.</li><li>Move up and down any instruction in the bottom column by selecting it and clicking the \"Up\" or \"Down\" buttons.</li><li>You can remove an instruction from the right column by selecting it and clicking the \"Remove\"button.</li><li>Click the \"Add spacer\" button to add a separator to the instructions in the bottom column. The separator will be added at the end, remember to move it up with the \"Up\" button.</li></ul>" }, // Use function for options since the set it is pointing to changes every time custominstructions is upda,ted
		basepath: { title: "Base path for media", type: "text", initial: "", help: "Base path to prefix to relative paths for the sources of image() and sound() instructions", advanced: true, },
	},
	"Code": {
		precode: { title: "Code to preload (hidden to the user)", type: "textarea", initial: "", help: "The code you write here will be hidden to the user but will be run immediately after loading eSeeCode and everytime before the user code.", advanced: true, },
		code: { title: "Code to load as user code (displayed to the user)", type: "textarea", initial: "", help: "The code you write here will be shown as part of the solution, so the user can view it and modify it.", },
		execute: { title: "Execute the user code", type: "checkbox", initial: "false", help: "Decide whether or not to run the user code immediately after loading eSeeCode.", advanced: true, },
		postcode: { title: "Code to postload (hidden to the user)", type: "textarea", initial: "", help: "The code you write here will be hidden to the user but will be run everytime after the user code.", advanced: true, },
		input: { title: "Input", type: "textarea", initial: "", help: "Set the input that will appear in the I/O toolbox.", },
	},
	"Share": {
		links: { type: "html", skipParameterInURL: true, },
		embed: { type: "html", skipParameterInURL: true, advanced: true, },
	}
	
}
var parametersCalledFromAPI;

function encodeExerciseURL(url) {
	if (url.includes('code=') || url.includes('custominstructions=')) { // code=, precode=, postcode=, custominstructions=
		let [ mainURL, ...restURL ] = url.split('?');
		let [ params, ...target ] = restURL.join('?').split('#');
		url = mainURL;
		if (params) url += '?e=' + btoa(params);
		if (target.length > 0) url += '#' + target.join('#');
	}
	return url;
}

function createExerciseTool(divId, createExerciseHandle, src, skipURL, mergeSteps, postRun) {
	handle = createExerciseHandle;
	if (!handle) handle = function(url) {
		url = encodeExerciseURL(url);
		document.getElementById("embed").innerHTML = "Use this code to embed the exercise in your website:<br /><br />&lt;iframe width=\"1000\" height=\"600\" src=\""+url+"\" allowfullscreen=\"true\">&lt;/iframe>" + (url.length >= 2000 ? "The resulting URL has 2000 characters or more. This URL might not load correctly on Internet Explorer browsers!" : "");
	};
	mainURL = src;
	if (!mainURL) {
		mainURL = "https://play.eseecode.com";
	}
	parametersCalledFromAPI = skipURL;
	var assistant = document.getElementById(divId);

	if (!mergeSteps) mergeSteps = {};
	if (typeof mergeSteps === 'function') {
		setupItems = mergeSteps(setupItems);
	} else {
		setupItems = Object.assign(setupItems, mergeSteps);
	}
	if (!Array.isArray(setupItems)) setupItems = Object.entries(setupItems).map(([page, setupPage]) => ({ page, setupPage }));
	var stepNumber = 1;
	var divSwitch = document.createElement("div");
	divSwitch.id = "switch";
	var element = document.createElement("span");
	//element.innerHTML = "Switch to: ";
	divSwitch.appendChild(element);
	element = document.createElement("input");
	element.id = "switchMode";
	element.type = "button";
	element.value = _("Full view");
	element.dataset.switchTo = "full";
	element.addEventListener("click", switchMode);
	divSwitch.appendChild(element);
	assistant.appendChild(divSwitch);
	var divSteps = document.createElement("div");
	divSteps.id = "steps";
	divSteps.class = "steps";
	setupItems.forEach(({ page, setupPage }) => {
		var div = document.createElement("div");
		div.id = "step-"+stepNumber;
		div.class = "step";
		var divTitle = document.createElement("div");
		divTitle.className = "pageTitle";
		divTitle.innerHTML = _(page);
		div.appendChild(divTitle);
		Object.keys(setupPage).forEach(key => createSetupField(setupPage, key, div));
		divSteps.appendChild(div);
		stepNumber++;
	});
	assistant.appendChild(divSteps);
	element = document.createElement("input");
	element.id = "stepNumber";
	element.type = "hidden";
	element.value = "1";
	assistant.appendChild(element);
	var divNavigator = document.createElement("div");
	divNavigator.id = "controls";
	divNavigator.class = "controls";
	var divButtons = document.createElement("div");
	divButtons.id = "controls-navigator";
	element = document.createElement("input");
	element.id = "prev";
	element.type = "button";
	element.value = "< Back";
	element.addEventListener("click",goToPrevStep);
	divButtons.appendChild(element);
	var element = document.createElement("select");
	element.id = "jump";
	stepNumber = 1;
	var options = "";
	setupItems.forEach(({ page }) => {
		options += "<option value=\""+stepNumber+"\">"+stepNumber+": "+_(page)+"</option>"; 
		stepNumber++;
	});
	element.innerHTML = options;
	element.addEventListener("change", jump);
	divButtons.appendChild(element);
	element = document.createElement("input");
	element.id = "next";
	element.type = "button";
	element.value = "Next >";
	element.addEventListener("click",goToNextStep);
	divButtons.appendChild(element);
	divNavigator.appendChild(divButtons);
	assistant.appendChild(divNavigator);
	if (postRun) postRun();
	goToStep();
	buildURL();
}

function createSetupField(setupPage, key, parentDiv) {
	let div = document.createElement("DIV");
	div.className = "page_field";
	if (setupPage[key].fieldset) {
		parentDiv.querySelector("[data-fieldset=\"" + setupPage[key].fieldset + "\"]").appendChild(div);
	} else {
		parentDiv.appendChild(div);
	}
	if (setupPage[key].advanced) div.classList.add("advanced");
	if (setupPage[key].category) div.dataset.category = setupPage[key].category;
	if (setupPage[key].title) {
		var title = document.createElement("DIV");
		title.className = "title";
		title.innerHTML = _(setupPage[key].title);
		title.innerHTML += " ";
		div.appendChild(title);
	}
	if (setupPage[key].help) {
		var divHelp = document.createElement("div");
		divHelp.className = "help";
		divHelp.innerHTML = _(setupPage[key].help);
		if (setupPage[key].initial || setupPage[key].userValue) {
			divHelp.innerHTML += "<br />";
			if (setupPage[key].initial) {
				divHelp.innerHTML += "<br /><u>" + _("Default") + ":</u> <i>"+decodeURIComponent(setupPage[key].initial)+"</i>";
			}
			if (setupPage[key].userValue) {
				divHelp.innerHTML += "<br /><u>" + _("Your saved value") + ":</u> <i>"+decodeURIComponent(setupPage[key].userValue)+"</i>";
			}
		}
		div.appendChild(divHelp);
	}
	if (setupPage[key].title && setupPage[key].type != "button" && setupPage[key].type != "fieldset") {
		var title = document.createElement("label");
		title.innerHTML = _(setupPage[key].title);
		if (setupPage[key].title.substring(setupPage[key].title.length-1) != "?") {
			title.innerHTML += ":";
		}
		title.innerHTML += " ";
		div.appendChild(title);
	}
	var defaultValue = (setupPage[key].userValue ? setupPage[key].userValue : setupPage[key].initial);
	if (setupPage[key].type == "fieldset") {
		div.classList.add("fieldset");
		div.dataset.fieldset = key;
		setupPage[key].skipParameterInURL = true;
	} else if (setupPage[key].type == "select") {
		var select = document.createElement("select");
		select.id = key;
		var options = setupPage[key].options;
		// Sort the items alphabetically
		if (setupPage[key].sort && options) {
			if ((typeof options[0]) === "object") {
				options = options.sort(function(a,b) {
					return a.name > b.name;
				});
			} else if (Array.isArray(options)) {
				options.sort();
			}
		}
		var selectOptions = "";
		for (var optionsKey in options) {
			var selected = "", selectId = "";
			var id, value;
			if ((typeof options[optionsKey]) === "object") {
				id = options[optionsKey].id;
				value = options[optionsKey].name;
				selectId = id;
			} else {
				value = options[optionsKey];
				id = value;
				selectId = value;
			}
			if (defaultValue && id && id.toLowerCase() === defaultValue.toLowerCase()) {
				selected = " selected";
			}
			selectOptions += "<option value=\""+selectId+"\""+selected+">"+_(value)+"</option>";
		}
		select.innerHTML = selectOptions;
		if (setupPage[key].events) Object.entries(setupPage[key].events).forEach(([ event, callback ]) => select.addEventListener(event, callback));
		if (!setupPage[key].skipParameterInURL) select.addEventListener("change", buildURL);
		div.appendChild(select);
	} else if (setupPage[key].type == "multiple") {
		var br = document.createElement("br");
		div.appendChild(br);
		var select = document.createElement("select");
		select.id = key;
		select.multiple = true;
		var options = setupPage[key].options;
		var selectOptions = "";
		for (var id in options) {
			var selected = "";
			if (defaultValue) {
				var defaultOptions = defaultValue.split(";");
				for (var defaultOption in defaultOptions) {
					if (options[id].toLowerCase() === defaultOptions[defaultOption].toLowerCase()) {
						selected = " selected";
					}
				}
			}
			selectOptions += "<option value=\""+options[id]+"\""+selected+">"+_(options[id])+"</option>";
		}
		select.innerHTML = selectOptions;
		if (setupPage[key].events) Object.entries(setupPage[key].events).forEach(([ event, callback ]) => select.addEventListener(event, callback));
		if (!setupPage[key].skipParameterInURL) select.addEventListener("change", buildURL);
		div.appendChild(select);
	} else if (setupPage[key].type == "instructions") {
		var br = document.createElement("br");
		div.appendChild(br);
		var defaultsSpan = document.createElement("span");
		defaultsSpan.innerHTML = _("Load defaults") + ": ";
		div.appendChild(defaultsSpan);
		var defaultsButton1 = document.createElement("input");
		defaultsButton1.type = "button";
		defaultsButton1.value = "Touch";
		div.appendChild(defaultsButton1);
		var defaultsButton2 = document.createElement("input");
		defaultsButton2.type = "button";
		defaultsButton2.value = "Drag";
		div.appendChild(defaultsButton2);
		var defaultsButton3 = document.createElement("input");
		defaultsButton3.type = "button";
		defaultsButton3.value = "Build";
		div.appendChild(defaultsButton3);
		var defaultsButton4 = document.createElement("input");
		defaultsButton4.type = "button";
		defaultsButton4.value = "Code";
		div.appendChild(defaultsButton4);
		var defaultsButton5 = document.createElement("input");
		defaultsButton5.type = "button";
		defaultsButton5.value = "Restore";
		defaultsButton5.style.display = "none";
		div.appendChild(defaultsButton5);
		var br = document.createElement("br");
		div.appendChild(br);
		var innerDiv = document.createElement("div");
		innerDiv.id = "instructionsbody";
		var elementId = key;
		var instructionsoriginDiv = document.createElement("div");
		instructionsoriginDiv.id = "instructionsorigindiv";
		innerDiv.appendChild(instructionsoriginDiv);
		var instructionsoriginfilterDiv = document.createElement("div");
		var instructionsoriginfilterSpan = document.createElement("span");
		instructionsoriginfilterSpan.innerHTML = _("Filter") + ": ";
		instructionsoriginfilterDiv.appendChild(instructionsoriginfilterSpan);
		var selectfilter = document.createElement("input");
		selectfilter.id = elementId+"originsearch";
		if (!setupPage[key].skipParameterInURL) selectfilter.addEventListener("keyup",function(event) {Array.from(document.getElementById(elementId+"origin").children).forEach(o => { if (o.innerHTML.startsWith(event.target.value)) o.removeAttribute("hidden"); else o.hidden = true; });});
		instructionsoriginfilterDiv.appendChild(selectfilter);
		instructionsoriginDiv.appendChild(instructionsoriginfilterDiv);
		var instructionsoriginaddDiv = document.createElement("div");
		var select = document.createElement("select");
		select.id = elementId+"origin";
		select.style.height = "150px";	
		select.multiple = true;
		instructionsoriginaddDiv.appendChild(select);
		var instructionsoriginspaceSpan = document.createElement("span");
		instructionsoriginspaceSpan.innerHTML = " ";
		instructionsoriginaddDiv.appendChild(instructionsoriginspaceSpan);
		var rightButton = document.createElement("input");
		rightButton.type = "button";
		rightButton.value = _("Add");
		rightButton.disabled = true;
		if (!setupPage[key].skipParameterInURL) rightButton.addEventListener("click",function() {selectOrderMove("right",elementId);buildURL();});
		instructionsoriginaddDiv.appendChild(rightButton);
		instructionsoriginDiv.appendChild(instructionsoriginaddDiv);
		var instructionsdestDiv = document.createElement("div");
		instructionsdestDiv.id = "instructionsdestdiv";
		instructionsdestDiv.style.display = "none";
		innerDiv.appendChild(instructionsoriginDiv);
		var instructionsdestSpan = document.createElement("span");
		instructionsdestSpan.innerHTML = "Selected instructions:";
		instructionsdestSpan.style.display = "block";
		instructionsdestDiv.appendChild(instructionsdestSpan);
		var select2 = document.createElement("select");
		select2.id = elementId;
		select2.style.height = "150px";
		select2.style.minWidth = "100px";
		select2.multiple = true;
		instructionsdestDiv.appendChild(select2);
		const observer = new MutationObserver((mutationList, observer) => {
			mutationList[0].target.parentNode.style.display = mutationList[0].target.children.length === 0 ? "none" : "block";
		});
		observer.observe(select2, { childList: true });
		var buttonsDiv = document.createElement("div");
		buttonsDiv.id = "instructionsbuttons";
		buttonsDiv.style.height = "150px";
		buttonsDiv.style.display = "inline-block";
		var upButton = document.createElement("input");
		upButton.type = "button";
		upButton.style.marginBottom = "0px";
		upButton.value = " " + _("Up") + " ";
		upButton.disabled = true;
		if (!setupPage[key].skipParameterInURL) upButton.addEventListener("click",function() {selectOrderMove("up",elementId);buildURL();});
		buttonsDiv.appendChild(upButton);
		br = document.createElement("br");
		buttonsDiv.appendChild(br);
		var downButton = document.createElement("input");
		downButton.type = "button";
		downButton.style.marginTop = "0px";
		downButton.value = _("Down");
		downButton.disabled = true;
		if (!setupPage[key].skipParameterInURL) downButton.addEventListener("click",function() {selectOrderMove("down",elementId);buildURL();});
		buttonsDiv.appendChild(downButton);
		br = document.createElement("br");
		buttonsDiv.appendChild(br);
		var setupButton = document.createElement("input");
		setupButton.type = "button";
		setupButton.style.marginTop = "1px";
		setupButton.value = _("Customize");
		setupButton.disabled = true;
		setupButton.dataset.elementId = elementId;
		setupButton.addEventListener("click", () => changeParameters({target: select2.selectedOptions[0]}));
		buttonsDiv.appendChild(setupButton);
		br = document.createElement("br");
		buttonsDiv.appendChild(br);
		var blankButton = document.createElement("input");
		blankButton.type = "button";
		blankButton.style.marginBottom = "1px";
		blankButton.value = _("Add spacer");
		if (!setupPage[key].skipParameterInURL) blankButton.addEventListener("click",function() {
			var option = document.createElement("option");
			option.value="blank;";
			option.innerHTML="-----";
			const selectEl = document.getElementById(elementId);
			selectEl.insertBefore(option, selectEl.selectedOptions[0]?.nextSibling);
			buildURL();
		});
		buttonsDiv.appendChild(blankButton);
		br = document.createElement("br");
		buttonsDiv.appendChild(br);
		var leftButton = document.createElement("input");
		leftButton.type = "button";
		leftButton.value = _("Remove");
		leftButton.disabled = true;
		if (!setupPage[key].skipParameterInURL) leftButton.addEventListener("click",function() {selectOrderMove("left",elementId);buildURL();});
		buttonsDiv.appendChild(leftButton);
		instructionsdestDiv.appendChild(buttonsDiv);
		innerDiv.appendChild(instructionsdestDiv);
		var selectOrder = {};
		var selectOptions = {};
		// Read default values
		if (defaultValue) {
			defaultValue = defaultValue.split(";");
			for (var j=0; j<defaultValue.length; j++) {
				var instructionName = defaultValue[j].trim();
				if ($e.instructions.set[instructionName]) {
					var defaultInstruction = instructionName+";"
					var k = 0;
					while (j+1+k < defaultValue.length && (
					  $e.isNumber(defaultValue[j+1+k],true) ||
					  $e.isBoolean(defaultValue[j+1+k],true) ||
					  decodeURIComponent(defaultValue[j+1+k]).startsWith("\"") ||
					  decodeURIComponent(defaultValue[j+1+k]).startsWith("'") ||
					  defaultValue[j+1+k] == "showParams" ||
					  defaultValue[j+1+k] == "noChange" ||
					  defaultValue[j+1+k].startsWith("param:") ||
					  defaultValue[j+1+k].startsWith("count:"))) {
	                    if (defaultValue[j+1+k] == "showParams") {
	                    	defaultInstruction += "showParams;";
	                    } else if (defaultValue[j+1+k] == "noChange") {
	                    	defaultInstruction += "noChange;";
	                    } else if (defaultValue[j+1+k].startsWith("count:")) {
	                    	var maxCount = parseInt(defaultValue[j+1+k].split(":")[1]);
	                    	defaultInstruction += "count:"+maxCount+";";
	                    } else if ($e.instructions.set[instructionName].parameters[k]) {
			            	var param = defaultValue[j+1+k];
	                    	if (param.startsWith("param:")) {
	                    		param = param.split(":")[1];
	                    	}
	                    	defaultInstruction += "param:"+param+";";
				        } else {
							console.warn("Error while loading instructions from URL: There is no "+$e.ordinal(k+1)+" parameter for instruction "+defaultValue[j]+". You tried to set it to: "+defaultValue[j+1+k]);
				        }
				        k++;
					}
					j += k;
					if (!selectOrder["lastSave"]) {
						selectOrder["lastSave"] = "";
					}
					selectOrder["lastSave"] += "<option ondblclick=\"changeParameters({target:this})\" value=\""+defaultInstruction+"\">"+instructionName+"</option>";
				} else {
					console.warn("Error while loading instructions from URL: Instruction "+instructionName+" doesn't exist");
				}
			}
		}
		// Create options
		createSortOptions(setupPage[key], select, selectOptions, selectOrder, elementId);
		select.addEventListener('change', (event) => {
			const disable = event.target.selectedOptions.length === 0;
			[ rightButton ].forEach(el => {
				if (disable) el.disabled = true;
				else el.removeAttribute('disabled');
			});
		});
		select2.addEventListener('change', event => {
			const disable = event.target.selectedOptions.length === 0;
			[ leftButton, upButton, downButton, setupButton ].forEach(el => {
				if (disable) el.disabled = true;
				else el.removeAttribute('disabled');
			});
		});
		if (!setupPage[key].skipParameterInURL) defaultsButton1.addEventListener("click",function() {select2.innerHTML = selectOrder["level1"];changeParametersClose();buildURL();});
		if (!setupPage[key].skipParameterInURL) defaultsButton2.addEventListener("click",function() {select2.innerHTML = selectOrder["level2"];changeParametersClose();buildURL();});
		if (!setupPage[key].skipParameterInURL) defaultsButton3.addEventListener("click",function() {select2.innerHTML = selectOrder["level3"];changeParametersClose();buildURL();});
		if (!setupPage[key].skipParameterInURL) defaultsButton4.addEventListener("click",function() {select2.innerHTML = selectOrder["level4"];changeParametersClose();buildURL();});
		if (selectOrder["lastSave"]) {
			select2.innerHTML = selectOrder["lastSave"];
			if (!setupPage[key].skipParameterInURL) defaultsButton5.addEventListener("click",function() {select2.innerHTML = selectOrder["lastSave"];changeParametersClose();buildURL();});
			defaultsButton5.style.display = "inline-block";
		}
		div.appendChild(innerDiv);
	} else if (setupPage[key].type == "custominstructions") {
		div.appendChild(createCustomInstructionsUI(defaultValue));
	} else if (setupPage[key].type == "textarea") {
		var input = document.createElement("textarea");
		input.id = key;
		if (defaultValue) {
			input.innerHTML = defaultValue;
		}
		if (setupPage[key].events) Object.entries(setupPage[key].events).forEach(([ event, callback ]) => input.addEventListener(event, callback));
		if (!setupPage[key].skipParameterInURL) input.addEventListener("change", buildURL);
		div.appendChild(input);
	} else if (setupPage[key].type == "html") {
		var innerDiv = document.createElement("div");
		if (setupPage[key].html) innerDiv.innerHTML = setupPage[key].html;
		innerDiv.id = key;
		div.appendChild(innerDiv);
	} else if (setupPage[key].type == "button") {
		var button = document.createElement("button");
		if (setupPage[key].html) button.innerHTML = setupPage[key].html;
		button.id = key;
		div.appendChild(button);
	} else {
		var input = document.createElement("input");
		input.id = key;
		if (setupPage[key].type) {
			input.type = setupPage[key].type;
			if (setupPage[key].min !== undefined) input.min = setupPage[key].min;
			if (setupPage[key].max !== undefined) input.max = setupPage[key].max;
			if (setupPage[key].step !== undefined) input.step = setupPage[key].step;
		}
		if (defaultValue) {
			if (setupPage[key].type == "checkbox") {
				input.checked = (defaultValue=="true"?true:false);
			} else {
				input.value = defaultValue;
			}
		}
		if (setupPage[key].events) Object.entries(setupPage[key].events).forEach(([ event, callback ]) => input.addEventListener(event, callback));
		if (!setupPage[key].skipParameterInURL) input.addEventListener("change", buildURL);
		div.appendChild(input);
	}
}

function createSortOptions(setupItem, select, selectOptions, selectOrder, elementId) {
	var options = setupItem.options;
	if (typeof options == "function") options = options();
	for (var i=0; i<$e.instructions.categories.length; i++) {
		var category = $e.instructions.categories[i];
		for (var id in options) {
			// Only show instructions in the current category
			if (category != $e.instructions.set[id].category) {
				continue;
			}
			if (!id.match(/blank[0-9]*/)) {
				selectOptions[options[id].name] = true;
			}
			var instructionName = options[id].name;
			if (instructionName === "blank") {
				instructionName = "-----";
			}
			var instruction = options[id].name+";";
			for (var param in options[id].parameters) {
				var value = options[id].parameters[param].initial;
				//value = encodeURIComponent($e.instructions.parsePredefinedConstants(value));
				instruction += "param:"+value+";";
			}
			for (var view in options[id].show) {
				var level = options[id].show[view];
				if (!selectOrder[level]) {
					selectOrder[level] = "";
				}
				selectOrder[level] += "<option ondblclick=\"changeParameters({target:this})\" value=\""+instruction+"\">"+instructionName+"</option>";
			}
		}
	}
	var selectOptionsKeys = [];
	for (var id in selectOptions) {
		selectOptionsKeys.push(id);
	}
	selectOptionsKeys.sort();
	var selectOptionsText = "";
	for (var id in selectOptionsKeys) {
		selectOptionsText += "<option ondblclick=\"selectOrderMove('right','"+elementId+"');buildURL()\" value=\""+selectOptionsKeys[id]+";\">"+selectOptionsKeys[id]+"</option>";
	}
	select.innerHTML = selectOptionsText;
}

function createCustomInstructionsUI(descr) {

	let customInstructionsSetEl = document.getElementById("custominstructions");
	let instructionsSetDiv;			
	if (!customInstructionsSetEl) {
		var div = document.createElement("div");
		div.className = "custominstructions";
		customInstructionsSetEl = document.createElement("textarea");
		customInstructionsSetEl.id = "custominstructions";
		customInstructionsSetEl.name = "custominstructions";
		customInstructionsSetEl.style.display = "none";
		div.appendChild(customInstructionsSetEl);

		var instructionsDiv = document.createElement("div");
		instructionsSetDiv = document.createElement("div");
		instructionsSetDiv.id = "custominstructionsset";
		instructionsDiv.appendChild(instructionsSetDiv);
		var instructionsNewDiv = document.createElement("div");
		var instructionsNewButton = document.createElement("button");
		instructionsNewButton.innerHTML = "+ " + _("Add instruction");
		instructionsNewButton.addEventListener("click", () => addOrUpdateCustomInstruction({}, instructionsSetDiv));
		instructionsNewDiv.appendChild(instructionsNewButton);
		instructionsDiv.appendChild(instructionsNewDiv);
		div.appendChild(instructionsDiv);
	} else {
		instructionsSetDiv = document.getElementById("custominstructionsset");
	}
	customInstructionsSetEl.value = descr;

	const customInstructions = JSON.parse(descr || "{}");
	Object.values(customInstructions).forEach((customInstruction) => applyCustomInstruction(customInstruction, instructionsSetDiv));

	return div;

}

function addOrUpdateCustomInstruction(instructionDescr, instructionsSetDiv) {

	if (instructionDescr && instructionDescr.id) {
		const row = document.querySelector("[data-id="+instructionDescr.id+"]");
		if (row) row.style.display = "none";
	}

	var instructionForm = document.createElement("form");
	instructionForm.className = "instructionWrapper";

	var instructionsIdEl = document.createElement("input");
	instructionsIdEl.id = "instructionId";
	instructionsIdEl.name = "id";
	instructionsIdEl.value = instructionDescr.id ? instructionDescr.id : "custom_" + Date.now() + "_" + Math.floor(Math.random() * 100000000);
	instructionsIdEl.style.display = "none";
	instructionForm.appendChild(instructionsIdEl);

	var instructionNameDiv = document.createElement("div");
	var instructionNameLabel = document.createElement("label");
	instructionNameLabel.innerHTML = _("Name") + ": ";
	instructionNameDiv.appendChild(instructionNameLabel);
	var instructionNameEl = document.createElement("input");
	instructionNameEl.id = "instructionName";
	instructionNameEl.name = "name";
	instructionNameEl.pattern = "[$a-zA-Z_][0-9a-zA-Z_$]*";
	instructionNameEl.value = instructionDescr.name ? instructionDescr.name : "";
	instructionNameEl.required = true;
	instructionNameDiv.appendChild(instructionNameEl);
	instructionNameEl.addEventListener("keyup", updateCustomInstructionWrappers);
	instructionNameEl.addEventListener("change", updateCustomInstructionWrappers);
	instructionForm.appendChild(instructionNameDiv);

	var instructionCategoryDiv = document.createElement("div");
	var instructionCategoryLabel = document.createElement("label");
	instructionCategoryLabel.innerHTML = _("Category") + ": ";
	instructionCategoryDiv.appendChild(instructionCategoryLabel);
	var instructionCategorySelect = document.createElement("select");
	instructionCategorySelect.name = "category";
	instructionCategorySelect.required = true;
	[ "", "guide", "canvas", "value", "draw", "window", "objects", "other" ].forEach(c => {
		var instructionCategoryOptionEl = document.createElement("option");
		instructionCategoryOptionEl.innerHTML = c;
		instructionCategoryOptionEl.value = c;
		instructionCategorySelect.appendChild(instructionCategoryOptionEl);
	});
	instructionCategoryDiv.appendChild(instructionCategorySelect);
	instructionForm.appendChild(instructionCategoryDiv);

	var instructionTypeDiv = document.createElement("div");
	var instructionTypeLabel = document.createElement("label");
	instructionTypeLabel.innerHTML = _("Type") + ": ";
	instructionTypeDiv.appendChild(instructionTypeLabel);
	var instructionTypeSelect = document.createElement("select");
	instructionTypeSelect.name = "type";
	[ "text", "number", "bool", "layer", "object", "window" ].forEach(c => {
		var instructionTypeOptionEl = document.createElement("option");
		instructionTypeOptionEl.innerHTML = c;
		instructionTypeOptionEl.value = c;
		instructionTypeSelect.appendChild(instructionTypeOptionEl);
	});
	instructionTypeDiv.appendChild(instructionTypeSelect);
	instructionForm.appendChild(instructionTypeDiv);

	var instructionLevelDiv = document.createElement("div");
	var instructionLevelLabel = document.createElement("label");
	instructionLevelLabel.innerHTML = _("Show in") + ": ";
	instructionLevelDiv.appendChild(instructionLevelLabel);
	var instructionLevelSelect = document.createElement("select");
	instructionLevelSelect.name = "show";
	instructionLevelSelect.multiple = true;
	[ "level1", "level2", "level3", "level4" ].forEach(c => {
		var instructionLevelOptionEl = document.createElement("option");
		instructionLevelOptionEl.innerHTML = c;
		instructionLevelOptionEl.value = c;
		instructionLevelOptionEl.setAttribute("selected", "selected");
		instructionLevelSelect.appendChild(instructionLevelOptionEl);
	});
	instructionLevelDiv.appendChild(instructionLevelSelect);
	instructionForm.appendChild(instructionLevelDiv);

	var instructionIconDiv = document.createElement("div");
	var instructionIconLabel = document.createElement("label");
	instructionIconLabel.innerHTML = _("Icon")  + ": ";
	instructionIconDiv.appendChild(instructionIconLabel);
	var instructionIconEl = document.createElement("input");
	instructionIconEl.id = "instructionIcon";
	instructionIconEl.name = "icon";
	instructionIconEl.placeholder = _("URL or image name");
	instructionIconDiv.appendChild(instructionIconEl);
	instructionForm.appendChild(instructionIconDiv);

	var instructionTipDiv = document.createElement("div");
	var instructionTipLabel = document.createElement("label");
	instructionTipLabel.innerHTML = _("Description") + ": ";
	instructionTipDiv.appendChild(instructionTipLabel);
	var instructionTipEl = document.createElement("input");
	instructionTipEl.name = "tip";
	instructionTipDiv.appendChild(instructionTipEl);
	
	var instructionParamsDiv = document.createElement("div");
	instructionForm.appendChild(instructionParamsDiv);

	var instructionParamsNewDiv = document.createElement("div");
	var instructionParamsNewEl = document.createElement("button");
	instructionParamsNewEl.innerHTML = "+ " + _("Add parameter");
	instructionParamsNewEl.addEventListener("click", (event) => addOrUpdateCustomInstructionParam({}, instructionParamsDiv, event));
	instructionParamsNewDiv.appendChild(instructionParamsNewEl);
	instructionForm.appendChild(instructionParamsNewDiv);

	var instructionCodeDiv = document.createElement("div");
	instructionCodeDiv.className = "instructionCodeDiv";
	instructionCodeDiv.style.display = "none";
	var instructionCodeLabel = document.createElement("label");
	instructionCodeLabel.innerHTML = _("Implement the instruction") + ": ";
	instructionCodeDiv.appendChild(instructionCodeLabel);
	var instructionCodeFirstLabel = document.createElement("div");
	instructionCodeFirstLabel.id = "instructionCodeFirstLabel";
	instructionCodeFirstLabel.innerHTML = "{";
	instructionCodeDiv.appendChild(instructionCodeFirstLabel);
	var instructionCodeEl = document.createElement("textarea");
	instructionCodeEl.name = "run";
	instructionCodeDiv.appendChild(instructionCodeEl);
	var instructionCodeLastLabel = document.createElement("div");
	instructionCodeLastLabel.innerHTML = "}";
	instructionCodeLastLabel.style.marginTop = "0px";
	instructionCodeDiv.appendChild(instructionCodeLastLabel);
	instructionForm.appendChild(instructionCodeDiv);

	var instructionSingleDiv = document.createElement("div");
	var instructionSingleLabel = document.createElement("label");
	instructionSingleLabel.innerHTML = _("Count as a single instruction") + ": ";
	instructionSingleDiv.appendChild(instructionSingleLabel);
	var instructionSingleEl = document.createElement("input");
	instructionSingleEl.type = "checkbox";
	instructionSingleEl.name = "single";
	instructionSingleEl.checked = instructionDescr.single ?? true;
	instructionSingleDiv.appendChild(instructionSingleEl);
	instructionForm.appendChild(instructionSingleDiv);

	var instructionAnimateDiv = document.createElement("div");
	var instructionAnimateLabel = document.createElement("label");
	instructionAnimateLabel.innerHTML = _("Keep animation") + ": ";
	instructionAnimateDiv.appendChild(instructionAnimateLabel);
	var instructionAnimateEl = document.createElement("input");
	instructionAnimateEl.type = "checkbox";
	instructionAnimateEl.name = "animate";
	instructionAnimateEl.checked = instructionDescr.animate ?? true;
	instructionAnimateDiv.appendChild(instructionAnimateEl);
	instructionForm.appendChild(instructionAnimateDiv);

	var instructionApplyDiv = document.createElement("div");
	var instructionApplyButton = document.createElement("input");
	instructionApplyButton.type = "submit";
	instructionApplyButton.value = _("Apply");
	instructionApplyDiv.appendChild(instructionApplyButton);
	var instructionCancelButton = document.createElement("button");
	instructionCancelButton.innerHTML = _("Cancel");
	instructionCancelButton.addEventListener("click", event => {
		if (instructionDescr && instructionDescr.id) {
			const row = document.querySelector("[data-id="+instructionDescr.id+"]");
			if (row) row.style.display = "block";
		}
		event.target.closest(".instructionWrapper").remove();
	});
	instructionApplyDiv.appendChild(instructionCancelButton);
	instructionForm.appendChild(instructionApplyDiv);

	instructionForm.addEventListener("submit", (event) => applyCustomInstruction(instructionForm, instructionsSetDiv, event));
	instructionsSetDiv.insertBefore(instructionForm, instructionsSetDiv.querySelector(`[data-id="${instructionDescr.name}"]`));

	updateCustomInstructionFields(instructionDescr, instructionForm);
	if (instructionDescr.parameters) instructionDescr.parameters.forEach(d => addOrUpdateCustomInstructionParam(d, instructionParamsDiv));
	updateCustomInstructionWrappers();

}

function getCustomInstructionFields(form, processParameters) {

	const descr = {};

	Object.values(form.querySelectorAll("input, select, textarea")).forEach(el => {

		if ([ "button", "submit", "reset", ].includes(el.type)) return;

		if (!processParameters && el.closest(".paramWrapper")) return;

		let value;
		if (el.tagName == "SELECT") {
			if (el.hasAttribute("multiple")) value = Array.from(el.selectedOptions).reduce((acc, o) => acc.concat(o.value), []);
			else value = el.value;
		} else if (el.type == "checkbox") {
			value = el.checked;
		} else {
			value = el.value;
			if (processParameters && el.name === "initial") {
				const paramType = form.querySelector("[name=type]").value;
				if (paramType === "number") value = parseFloat(el.value);
				else if (paramType === "bool") !value || value === "false" || value == "0" || value === false ? false : true;
			}
		}

		const key = el.name;
		descr[key] = value;

	});

	return descr;

}

function updateCustomInstructionFields(instructionDescr, form) {

	Object.keys(instructionDescr).forEach(key => {

		if (!key) return;

		const value = instructionDescr[key];
		if (!value) return;

		const el = form.querySelector("[name=" + key + "]");
		if (!el) return;

		if (el.tagName == "SELECT") {
			Array.from(el.children).forEach(o => o.selected = value.includes(o.value));
		} else if (el.type == "checkbox") {
			el.checked = value;
		} else {
			el.value = value;
		}

	});

}

function applyCustomInstruction(instructionDescr, instructionsSetDiv, event) {

	if (event) event.preventDefault();

	if (instructionDescr instanceof HTMLElement) {
		const form = instructionDescr;
		instructionDescr = {
			id: form.querySelector("#instructionId").value,
			name: form.querySelector("#instructionName").value,
		};
		const customInstructionsSetEl = document.getElementById("custominstructions");
		const customInstructionsSet = JSON.parse(customInstructionsSetEl.value);
		customInstructionsSet[instructionDescr.id] = getCustomInstructionFields(form, false);
		customInstructionsSet[instructionDescr.id].parameters = Array.from(form.querySelectorAll(".paramWrapper")).reduce((acc, el) => acc.concat(getCustomInstructionFields(el, true)), []);
		customInstructionsSetEl.value = JSON.stringify(customInstructionsSet);
		form.remove();
	}

	var instructionDiv = document.createElement("div");
	instructionDiv.dataset.id = instructionDescr.id;
	instructionDiv.className = "instructionRowWrapper";
	var instructionSpan = document.createElement("span");
	instructionSpan.innerHTML = instructionDescr.name;
	instructionDiv.appendChild(instructionSpan);
	var instructionEditButton = document.createElement("button");
	instructionEditButton.innerHTML = "Edit";
	instructionEditButton.addEventListener("click", () => addOrUpdateCustomInstruction(JSON.parse(document.getElementById("custominstructions").value)[instructionDescr.id], instructionsSetDiv));
	instructionDiv.appendChild(instructionEditButton);
	var instructionRemoveButton = document.createElement("button");
	instructionRemoveButton.innerHTML = "Remove";
	instructionRemoveButton.addEventListener("click", (event) => event.target.closest(".instructionRowWrapper").parentNode.removeChild(event.target.closest(".instructionRowWrapper")));
	instructionDiv.appendChild(instructionRemoveButton);
	const previousInstructionDiv = document.querySelector("[data-id="+instructionDescr.id+"]");
	if (previousInstructionDiv) {
		previousInstructionDiv.parentNode.insertBefore(instructionDiv, previousInstructionDiv);
		previousInstructionDiv.parentNode.removeChild(previousInstructionDiv);
	} else {
		instructionsSetDiv.appendChild(instructionDiv);
	}

	updateInstructions();
	buildURL();

	return false;

}

function addOrUpdateCustomInstructionParam(instructionParamDescr, instructionParamsDiv, event) {

	if (event) event.preventDefault();

	var instructionParamDiv = document.createElement("div");
	instructionParamDiv.className = "paramWrapper";

	var instructionParamNameLabel = document.createElement("label");
	instructionParamNameLabel.innerHTML = _("Name") + ": ";
	instructionParamDiv.appendChild(instructionParamNameLabel);
	var instructionParamNameEl = document.createElement("input");
	instructionParamNameEl.name = "name";
	instructionParamNameEl.pattern = "[$a-zA-Z_][0-9a-zA-Z_$]*";
	instructionParamNameEl.className = "paramName";
	instructionParamNameEl.required = true;
	instructionParamNameEl.addEventListener("keyup", updateCustomInstructionWrappers);
	instructionParamNameEl.addEventListener("change", updateCustomInstructionWrappers);
	instructionParamDiv.appendChild(instructionParamNameEl);

	var instructionParamTypeDiv = document.createElement("div");
	var instructionParamTypeLabel = document.createElement("label");
	instructionParamTypeLabel.innerHTML = _("Type") + ": ";
	instructionParamTypeDiv.appendChild(instructionParamTypeLabel);
	var instructionParamTypeSelect = document.createElement("select");
	instructionParamTypeSelect.name = "type";
	[ "text", "number", "bool", "layer", "object", "window" ].forEach(c => {
		var instructionParamTypeOptionEl = document.createElement("option");
		instructionParamTypeOptionEl.innerHTML = c;
		instructionParamTypeOptionEl.value = c;
		instructionParamTypeSelect.appendChild(instructionParamTypeOptionEl);
	});
	instructionParamTypeDiv.appendChild(instructionParamTypeSelect);
	instructionParamDiv.appendChild(instructionParamTypeDiv);

	var instructionParamTipDiv = document.createElement("div");
	var instructionParamTipLabel = document.createElement("label");
	instructionParamTipLabel.innerHTML = _("Description") + ": ";
	instructionParamTipDiv.appendChild(instructionParamTipLabel);
	var instructionParamTipEl = document.createElement("input");
	instructionParamTipEl.name = "tip";
	instructionParamTipDiv.appendChild(instructionParamTipEl);
	instructionParamDiv.appendChild(instructionParamTipDiv);

	var instructionParamOptionalDiv = document.createElement("div");
	var instructionParamOptionalLabel = document.createElement("label");
	instructionParamOptionalLabel.innerHTML = _("Is optional") + ": ";
	instructionParamOptionalDiv.appendChild(instructionParamOptionalLabel);
	var instructionParamOptionalEl = document.createElement("input");
	instructionParamOptionalEl.type = "checkbox";
	instructionParamOptionalEl.name = "optional";
	instructionParamOptionalDiv.appendChild(instructionParamOptionalEl);
	instructionParamDiv.appendChild(instructionParamOptionalDiv);

	var instructionParamInitialDiv = document.createElement("div");
	var instructionParamInitialLabel = document.createElement("label");
	instructionParamInitialLabel.innerHTML = _("Default value") + ": ";
	instructionParamInitialDiv.appendChild(instructionParamInitialLabel);
	var instructionParamInitialEl = document.createElement("input");
	instructionParamInitialEl.name = "initial";
	instructionParamInitialDiv.appendChild(instructionParamInitialEl);
	instructionParamDiv.appendChild(instructionParamInitialDiv);

	var instructionParamRemoveDiv = document.createElement("div");
	var instructionParamRemoveEl = document.createElement("button");
	instructionParamRemoveEl.innerHTML = _("Remove parameter");
	instructionParamRemoveEl.addEventListener("click", (event) => { event.target.closest(".paramWrapper").remove(); updateCustomInstructionWrappers(); });
	instructionParamRemoveDiv.appendChild(instructionParamRemoveEl);
	instructionParamDiv.appendChild(instructionParamRemoveDiv);

	instructionParamsDiv.appendChild(instructionParamDiv);

	updateCustomInstructionFields(instructionParamDescr, instructionParamDiv);

	return false;

}

function updateCustomInstructionWrappers() {
	var readyName = !!document.getElementById("instructionName")?.value;
	Array.from(document.querySelectorAll(".instructionCodeDiv")).forEach(el => el.style.display = readyName ? "block" : "none");
	if (!readyName) return;
	var name = document.getElementById("instructionName").value;
	var params = Array.from(document.querySelectorAll(".paramName")).reduce((acc, el) => acc + (acc ? ", " : "") + el.value, "");

	document.getElementById("instructionCodeFirstLabel").innerHTML = "function "+name+"("+params+") {";
}

function updateInstructions() {
	let custominstructions = document.getElementById("custominstructions").value;
	try {
		custominstructions = JSON.parse(custominstructions);
	} catch(error) { console.error("Invalid custominstructions update JSON: " + custominstructions); }
	if (!custominstructions) {
		alert("Custom instructions' descriptions has invalid synthax");
		return;
	}
	$e.instructions.set = Object.assign({}, $e.instructions._set, custominstructions);
	let setupItem = setupItems.find(({ page }) => page === "Instructions").setupPage["instructions"];
	createSortOptions(setupItem, document.getElementById("instructionsorigin"), {}, {}, "instructions");
}

function goToNextStep() {
	var step = document.getElementById("stepNumber").getAttribute("value");
	step++;
	goToStep(step);
}

function goToPrevStep() {
	var step = document.getElementById("stepNumber").getAttribute("value");
	step--;
	goToStep(step);
}

function goToStep(step) {
	if (step === undefined || typeof step === "object") { //goToStep is also called as a listener, so make sure step is not a event
		step = document.getElementById("stepNumber").getAttribute("value");
	}
	step = parseInt(step);
	hideAll();
	document.getElementById("steps").scrollTop = 0;
	document.getElementById("step-"+step).classList.remove("hidden");
	document.getElementById("stepNumber").value = step;
	if (step === 1) {
		document.getElementById("prev").disabled = true;
	} else {
		document.getElementById("prev").removeAttribute("disabled");
	}
	if (!document.getElementById("step-"+(step+1))) {
		document.getElementById("next").disabled = true;
	} else {
		document.getElementById("next").removeAttribute("disabled");
	}
	document.getElementById("jump").value = step;
}

function hideAll(step) {
	for (var i=1,element=null; element = document.getElementById("step-"+i); i++) {
		element.classList.add("hidden");
	}
}

function showAll() {
	for (var i=1,element=null; element = document.getElementById("step-"+i); i++) {
		element.classList.remove("hidden");
	}
}

function jump() {
	var step = document.getElementById("jump").value;
	goToStep(step);
}

function switchMode() {
	var button = document.getElementById("switchMode");
	var switchTo = button.getAttribute("data-switchTo");
	if (switchTo === "full") {
		showAll();
		document.getElementById("controls-navigator").style.display = "none";
		button.value = _("Wizard view");
		button.dataset.switchTo = "wizard";
	} else {
		goToStep();
		document.getElementById("controls-navigator").style.display = "block";
		button.value = _("Full view");
		button.dataset.switchTo = "full";
	}
}

function buildURL(event) {
	if (buildURL.disabled) return;

	var url = mainURL;
	var components = [];
	var paramsText = "";
	setupItems.forEach(({ setupPage }) => {
		Object.entries(setupPage).forEach(([key, setupPageItem]) => {
			if (setupPageItem.type == "html" || setupPageItem.type == "fieldset") {
				return;
			}
			var paramValue = "";
			var element = document.getElementById(key);
			if (setupPageItem.type == "checkbox") {
				paramValue = element.checked === true;
			} else if (setupPageItem.type == "order" || setupPageItem.type == "instructions") {
				paramValue = "";
				let options = element.options;
				if (typeof options == "function") options = options();
				for (var optionId in options) {
					if (optionId.match(/^[0-9]+$/)) { // IE add some options so skip them
						var option = options[optionId];
						if (option.value) {
							paramValue += option.value;
						}
					}
				}
				if (paramValue) {
					paramValue = paramValue.substring(0,paramValue.length-1); // Remove last ";"
				}
			} else if (setupPageItem.type == "multiple") {
				paramValue = "";
				let options = element.options;
				if (typeof options == "function") options = options();
				for (var optionId in options) {
					if (optionId.match(/^[0-9]+$/)) { // IE add some options so skip them
						var option = options[optionId];
						if (option.selected) {
							paramValue += option.value+";";
						}	
					}
				}
				if (paramValue) {
					paramValue = paramValue.substring(0,paramValue.length-1); // Remove last ";"
				}
			} else {
				paramValue = element.value;
			}
			if (!setupPageItem.skipParameterInURL && paramValue != setupPageItem.initial && paramValue.toString().length > 0) {
				if ((setupPageItem.type !== "order" || setupPageItem.type !== "instructions") && setupPageItem.type !== "multiple" && setupPageItem.type !== "select") paramValue = encodeURIComponent(paramValue);
				var component = key+"="+paramValue;
				components.push(component);
				var skipParameterInURL = false;
				for (var j in parametersCalledFromAPI) {
                    if (component.startsWith(parametersCalledFromAPI[j]+"=")) {
                        skipParameterInURL = true;
                    }
				}
				if (!skipParameterInURL) {
					paramsText += "&"+component;
				}
			}
		});
	});
	if (paramsText.length > 0) {
		paramsText = paramsText.substring(1); // Remove the first "&" from the URL
		url += "?"+paramsText;
	}
	handle(url, components);
}

function selectOrderMove(sens, id) {
	var sourceSel, targetSel; 
	if (sens == "right") {
		sourceSel = document.getElementById(id+"origin"); 
		targetSel = document.getElementById(id);
	} else {
		sourceSel = document.getElementById(id); 
		targetSel = document.getElementById(id+"origin");
	}
	if (sens == "up") {
		for (var i = 0; i<sourceSel.options.length; i++) {
			if (sourceSel.options[i].selected) {
				var moveOption = sourceSel.options[i];
				var above = moveOption.previousSibling;
				sourceSel.removeChild(moveOption);
				if (above) {
					sourceSel.insertBefore(moveOption, above);
				} else {
					sourceSel.insertBefore(moveOption, sourceSel.firstChild);
				}
			}
		}
	} else {
		for (var i = sourceSel.options.length-1; i>=0; i--) {
			if (sourceSel.options[i].selected) { 
				if (sens == "right") {
					var option = document.createElement("option");
					option.innerHTML = sourceSel.options[i].innerHTML;
					option.value = sourceSel.options[i].value;
					targetSel.appendChild(option);
					option.addEventListener("dblclick",changeParameters);
				} else if (sens == "left") {
					sourceSel.removeChild(sourceSel.options[i]);
				} else if (sens == "down") {
					var moveOption = sourceSel.options[i];
					var under = moveOption.nextSibling;
					if (under) {
						under = under.nextSibling;
					}
					sourceSel.removeChild(moveOption);
					if (under) {
						sourceSel.insertBefore(moveOption, under);
					} else {
						sourceSel.appendChild(moveOption);
					}
				}
			}
		}
	}
}

function changeParameters(event) {
	var target = undefined;
	if (event.target?.getAttribute("data-elementId")) {
		// Calling from button
		var select = document.getElementById(event.target.getAttribute("data-elementId"));
		for (var i = select.options.length-1; i>=0; i--) {
			if (select.options[i].selected) {
				target = select.options[i];
			} 
		}
	} else {
		// Calling from select option
		target = event.target;
	}
	if (!target) {
		return;
	}
	var instructionName = target.innerHTML;
	if (instructionName == "-----") return;
	var setupDiv = document.createElement("div");
	setupDiv.innerHTML = "<div id=\"setupDivTitle\">Setup for '"+instructionName+"':</div>" +
		"<input id=\"setupDivIndex\" type=\"hidden\" />" +
		"<input id=\"setupDivName\" type=\"hidden\" />" +
		"<div id=\"setupDivParams\"></div>" +
		"Max amount of instances: <input id=\"setupDivCount\" type=\"number\" min=\"0\" /><br />" +
		"Show parameters in Drag mode blocks: <input id=\"setupDivShowParams\" type=\"checkbox\" /><br />" +
		"Disable setup: <input id=\"setupDivNoChange\" type=\"checkbox\" /><br />" +
		"<input type=\"button\" value=\"Apply\" onclick=\"changeParametersApply('instructions')\" />";
	setupDiv.id = "setupDiv";
	var instructionParameters = $e.instructions.set[instructionName].parameters;
	for (var i=0; i<instructionParameters?.length; i++) {
		var initialHelper = ((!instructionParameters[i].optional || instructionParameters[i].optional === false) && instructionParameters[i].initial)?" Default: "+instructionParameters[i].initial:"";
		setupDiv.querySelector("#setupDivParams").innerHTML += $e.ordinal(i+1)+" parameter '"+instructionParameters[i].name +"' ("+instructionParameters[i].type+"): <input id=\"setupDivParam"+(i+1)+"\" />"+initialHelper+"<br />";
	}
	var countParams = 1;
	var values = target.value.split(";");
	for (var i=0; i<values.length; i++) {
		var value = values[i];
		if (i == 0) {
			setupDiv.querySelector("#setupDivName").value = values[i];
		} else if (value == "showParams") {
			setupDiv.querySelector("#setupDivShowParams").checked = true;
		} else if (value == "noChange") {
			setupDiv.querySelector("#setupDivNoChange").checked = true;
		} else if (value.match(/^count:/)) {
			setupDiv.querySelector("#setupDivCount").value = value.split(":")[1];
		} else if (value.match(/^param:/)) {
			setupDiv.querySelector("#setupDivParam"+countParams).value = decodeURIComponent(value.split(":")[1]);
			countParams++;
		} else if (setupDiv.querySelector("#setupDivParam"+countParams)) {
			setupDiv.querySelector("#setupDivParam"+countParams).value = decodeURIComponent(value);
			countParams++;
		}
	}
	var optionIndex = target.index;
	setupDiv.querySelector("#setupDivIndex").value = optionIndex;
	dialog(setupDiv);
}

function changeParametersApply(selectId) {
	var setupDiv = document.getElementById("setupDiv");
	var select = document.getElementById(selectId);
	var optionIndex = document.getElementById("setupDivIndex").value;
	var option = select.options[optionIndex];
	var name = option.innerHTML;
	var optionText = "";
	var inputs = setupDiv.getElementsByTagName("input");
	var foundNonUndefined = false;
	for (var i = inputs.length-1; i>=0; i--) {
		var input = inputs[i];
		if (input.type == "hidden") {
			continue;
		} else if (input.type == "number") {
			if (input.value) {
				optionText += "count:"+input.value+";";
			}
		} else if (input.type == "checkbox"){
			if (input.checked) {
				optionText += input.id == "setupDivNoChange" ? "noChange;" : "showParams;";
			}
		} else if (input.type == "button") {
			continue;
		} else {
			if (!input.value && !foundNonUndefined) {
				continue;
			}
			optionText = "param:"+encodeURIComponent(input.value)+";"+optionText; // Prefix
			foundNonUndefined = true;
		}
	}
	
	var optionText = name+";"+optionText;
	select.options[optionIndex].innerHTML = name;
	select.options[optionIndex].value = optionText;
	changeParametersClose();
	buildURL();
	setupDiv.parentNode.close();
}

function changeParametersClose() {
	document.getElementById("instructionsbody").style.display = "";
	var setupDiv = document.getElementById("setupDiv");
	if (setupDiv) setupDiv.style.display = "none";
}
